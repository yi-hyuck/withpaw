<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    layout:decorate="~{layout}"> <head layout:fragment="head"> <meta charset="UTF-8">
    <title>반려동물 증상 챗봇</title>
    
    <meta name="_csrf" th:content="${_csrf.token}" sec:authorize="isAuthenticated()"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" sec:authorize="isAuthenticated()"/>
    
    <style>
        /* CSS 내용은 여기에 유지 */
        #chat-window {
            height: 500px;
            border: 1px solid #ddd;
            overflow-y: scroll;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message-user { text-align: right; color: #007bff; }
        .message-bot { text-align: left; color: #28a745; background-color: #e9ecef; padding: 5px; border-radius: 5px; margin-bottom: 5px;}
        .message-bot strong { color: #1e7e34; }
    </style>
</head>

<div layout:fragment="content" class="container my-3"> 
    <h1>반려동물 증상 상담 챗봇</h1>
    <p>지금 로그인하신 회원님의 등록된 반려동물 정보를 기반으로 상담을 진행합니다.</p>
    
    <div id="chat-window">
        <div class="message-bot">
            <strong>챗봇:</strong> 안녕하세요! 저는 반려동물 상담 챗봇입니다. 반려동물의 증상이나 궁금한 점을 편하게 말씀해주세요. 
            
         
        </div>
    </div>

    <form id="chat-form">
        <input type="text" id="user-input" placeholder="반려동물의 증상을 입력해주세요." style="width: 89%; padding: 8px;">
        <button type="submit" style="width: 10%; padding: 8px;">전송</button>
    </form>

    <script>
        // ... (JavaScript 코드는 동일하게 유지) ...
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userInput = document.getElementById('user-input');
            const userMessage = userInput.value.trim();

            if (userMessage === "") return;

            // 사용자 메시지 표시
            appendMessage('사용자', userMessage, 'message-user');
            userInput.value = ''; // 입력 필드 초기화

            // CSRF 토큰 가져오기 (Spring Security 사용 시 필수)
            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            // AJAX 요청 (Fetch API 사용)
            fetch('/api/chatbot/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken // CSRF 헤더 추가
                },
                body: new URLSearchParams({
                    'userMessage': userMessage
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('챗봇 응답 실패: ' + response.statusText);
                }
                return response.text();
            })
            .then(data => {
                // 챗봇 응답 표시
                appendMessage('Chatbot', data, 'message-bot');
            })
            .catch(error => {
                console.error('Error:', error);
                appendMessage('System', '챗봇 응답을 가져오는 데 실패했습니다. 다시 시도해 주세요.', 'message-bot');
            });
        });

        function appendMessage(sender, message, className) {
            const chatWindow = document.getElementById('chat-window');
            const messageElement = document.createElement('div');
            messageElement.className = className;
            // 줄바꿈 문자(\n)를 HTML의 <br> 태그로 변환하여 표시
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message.replace(/\n/g, '<br>')}`;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight; // 스크롤 하단으로 이동
        }
    </script>
</div>
</html>